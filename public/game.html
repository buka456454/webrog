<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRog - Multiplayer Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .game-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.8);
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .controls {
            position: fixed;
            top: 32px;
            left: 32px;
            background: rgba(24,24,24,0.97);
            border: 1.5px solid #333;
            border-radius: 16px;
            padding: 22px 28px 18px 28px;
            z-index: 101;
            min-width: 340px;
            max-width: 420px;
            font-size: 16px;
            line-height: 1.7;
            box-shadow: 0 8px 32px #000a;
            color: #fff;
        }
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .controls-title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #3fa7ff;
        }
        .controls-close {
            font-size: 22px;
            color: #aaa;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }
        .controls-close:hover {
            color: #ff4444;
        }
        .controls-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .controls-list li {
            margin: 10px 0 0 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        canvas {
            border: 2px solid #333;
            border-radius: 8px;
            background: #0a0a0a;
            /* –†–∞–∑–º–µ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è JavaScript */
            max-width: none !important;
            max-height: none !important;
            object-fit: none !important;
        }
        
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            justify-content: center;
            align-items: center;
            min-height: 0;
            position: relative;
        }
        
        #gameCanvas {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .minimap {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .chat {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: #111827;
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            min-height: 150px;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 4px;
            color: white;
        }
        .chat-input button {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background: #1d4ed8;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-content h2 {
            margin: 0 0 15px 0;
            color: #0070f3;
            font-size: 24px;
        }
        
        .modal-content p {
            margin: 0 0 20px 0;
            color: #ccc;
            font-size: 16px;
        }
        
        .nickname-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .nickname-input input {
            flex: 1;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .nickname-input input:focus {
            border-color: #0070f3;
        }
        
        .nickname-input button {
            padding: 12px 20px;
            background: #0070f3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .nickname-input button:hover {
            background: #0056b3;
        }
        
        .nickname-error {
            color: #ff4444;
            font-size: 14px;
            min-height: 20px;
        }
        
        .respawn-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .respawn-content {
            background: #1a1a1a;
            border: 2px solid #ff4444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .respawn-content h2 {
            margin: 0 0 15px 0;
            color: #ff4444;
            font-size: 24px;
        }
        
        .respawn-content p {
            margin: 0 0 20px 0;
            color: #ccc;
            font-size: 16px;
        }
        
        .respawn-button {
            padding: 12px 24px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .respawn-button:hover {
            background: #cc3333;
        }
        
        .leaderboard {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .leaderboard h3 {
            margin: 0 0 10px 0;
            color: #0070f3;
        }
        
        .leaderboard-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-size: 14px;
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .leaderboard-rank {
            width: 25px;
            font-weight: bold;
            color: #0070f3;
        }
        
        .leaderboard-name {
            flex: 1;
            margin-left: 8px;
        }
        
        .leaderboard-kills {
            color: #ff4444;
            font-weight: bold;
        }
        
        .leaderboard-player-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
        }
        
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 200px;
                flex-direction: row;
                overflow-x: auto;
            }
            .minimap, .leaderboard, .chat {
                min-width: 200px;
                margin-right: 10px;
            }
            .controls {
                max-width: 250px;
            }
            /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Ä–∞–∑–º–µ—Ä canvas —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è JavaScript */
        }
        .rules-btn {
          position: fixed;
          top: 32px;
          left: 32px;
          z-index: 2000;
          background: #23272f;
          color: #3fa7ff;
          border: none;
          border-radius: 10px;
          padding: 12px 22px;
          font-size: 18px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 2px 8px #0005;
          transition: background 0.2s, color 0.2s;
        }
        .rules-btn:hover {
          background: #3fa7ff;
          color: #fff;
        }
        .rules-modal {
          position: fixed;
          top: 0; left: 0; width: 100vw; height: 100vh;
          z-index: 3000;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .rules-modal-backdrop {
          position: absolute;
          top: 0; left: 0; width: 100vw; height: 100vh;
          background: rgba(0,0,0,0.65);
          z-index: 1;
        }
        .rules-modal-content {
          position: relative;
          z-index: 2;
          background: #181a20;
          border-radius: 18px;
          box-shadow: 0 8px 32px #000a;
          min-width: 340px;
          max-width: 95vw;
          padding: 32px 36px 28px 36px;
          animation: rules-modal-in 0.22s cubic-bezier(.4,2,.6,1);
        }
        @keyframes rules-modal-in {
          from { opacity: 0; transform: scale(0.95); }
          to   { opacity: 1; transform: scale(1); }
        }
        .rules-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 18px;
        }
        .rules-modal-title {
          font-size: 22px;
          font-weight: 700;
          color: #3fa7ff;
        }
        .rules-modal-close {
          font-size: 26px;
          color: #aaa;
          cursor: pointer;
          user-select: none;
          transition: color 0.2s;
        }
        .rules-modal-close:hover {
          color: #ff4444;
        }
        .rules-list {
          list-style: none;
          padding: 0;
          margin: 0;
        }
        .rules-list li {
          margin: 12px 0 0 0;
          font-size: 17px;
          display: flex;
          align-items: center;
          gap: 10px;
          color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div id="nicknameModal" class="modal">
        <div class="modal-content">
            <h2>üéÆ Welcome to WebRog!</h2>
            <p>Enter your nickname to join the game:</p>
            <div class="nickname-input">
                <input type="text" id="nicknameInput" placeholder="Enter your nickname..." maxlength="20" autocomplete="off">
                <button onclick="joinGame()">Join Game</button>
            </div>
            <div class="nickname-error" id="nicknameError"></div>
        </div>
    </div>

    <div id="respawnModal" class="respawn-modal">
        <div class="respawn-content">
            <h2>üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏!</h2>
            <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è</p>
            <button class="respawn-button" onclick="respawnPlayer()">–í–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ -->
        <button class="rules-btn" id="rulesBtn" onclick="openRulesModal()">üìñ –ü—Ä–∞–≤–∏–ª–∞</button>
        <!-- –ú–æ–¥–∞–ª–∫–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ -->
        <div class="rules-modal" id="rulesModal" style="display:none;">
          <div class="rules-modal-backdrop" onclick="closeRulesModal(event)"></div>
          <div class="rules-modal-content">
            <div class="rules-modal-header">
              <span class="rules-modal-title">üìñ –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</span>
              <span class="rules-modal-close" onclick="closeRulesModal(event)">‚úï</span>
            </div>
            <ul class="rules-list">
              <li>‚å®Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π WASD –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è</li>
              <li>‚ö° SHIFT ‚Äî —Ä—ã–≤–æ–∫ –∫ –∫—É—Ä—Å–æ—Ä—É</li>
              <li>‚öîÔ∏è E ‚Äî –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ—Ä—É–∂–∏–µ</li>
              <li>üóëÔ∏è Q ‚Äî –≤—ã–±—Ä–æ—Å–∏—Ç—å –æ—Ä—É–∂–∏–µ</li>
              <li>üó°Ô∏è –õ–ö–ú ‚Äî –∞—Ç–∞–∫–∞</li>
              <li>üí¨ –ß–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</li>
              <li>üë• <span id="playerCount">0</span> –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</li>
            </ul>
          </div>
        </div>
        <div class="game-area" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <div class="sidebar">
            <div class="minimap">
                <h3>üó∫Ô∏è Mini Map</h3>
                <canvas id="minimapCanvas" width="200" height="150"></canvas>
            </div>
            
            <div class="leaderboard">
                <h3>üèÜ –¢–æ–ø –ø–æ –∫–∏–ª–ª–∞–º</h3>
                <div id="leaderboardList" class="leaderboard-list">
                    <div style="color: #6b7280; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞...</div>
                </div>
            </div>
            
            <div class="chat">
                <h3>üí¨ Chat</h3>
                <div id="chatMessages" class="chat-messages">
                    <div style="color: #6b7280; font-size: 14px;">Connecting to server...</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." maxlength="200">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ canvas —Å DOM
        function resizeGameCanvas() {
            const container = document.querySelector('.game-area');
            if (!container) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä canvas –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
            let canvasWidth, canvasHeight;
            
            if (window.innerWidth <= 768) {
                // –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                canvasWidth = 800;
                canvasHeight = 600;
            } else {
                // –î–µ—Å–∫—Ç–æ–ø
                canvasWidth = 1200;
                canvasHeight = 800;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
            gameCanvas.width = canvasWidth;
            gameCanvas.height = canvasHeight;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS —Ä–∞–∑–º–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            gameCanvas.style.width = canvasWidth + 'px';
            gameCanvas.style.height = canvasHeight + 'px';
        }
        window.addEventListener('resize', resizeGameCanvas);
        document.addEventListener('DOMContentLoaded', resizeGameCanvas);
        
        // –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ–º resizeGameCanvas –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', resizeGameCanvas);
        } else {
            resizeGameCanvas();
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è
        function respawnPlayer() {
            console.log('–ö–Ω–æ–ø–∫–∞ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞');
            if (socket) {
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ playerRespawn');
                socket.emit('playerRespawn');
                hideRespawnModal();
            } else {
                console.log('Socket –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            }
        }
        
        function showRespawnModal() {
            console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è');
            if (respawnModal) {
                respawnModal.style.display = 'flex';
                console.log('–ú–æ–¥–∞–ª–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞:', respawnModal.style.display);
            } else {
                console.log('–ú–æ–¥–∞–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
        }
        
        function hideRespawnModal() {
            console.log('–°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è');
            if (respawnModal) {
                respawnModal.style.display = 'none';
            }
        }
        
        let socket = null;
        const gameCanvas = document.getElementById('gameCanvas');
        const minimapCanvas = document.getElementById('minimapCanvas');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const playerCount = document.getElementById('playerCount');
        const nicknameModal = document.getElementById('nicknameModal');
        const gameContainer = document.getElementById('gameContainer');
        const nicknameInput = document.getElementById('nicknameInput');
        const nicknameError = document.getElementById('nicknameError');
        const respawnModal = document.getElementById('respawnModal');
        console.log('–ú–æ–¥–∞–ª–∫–∞ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–∞:', !!respawnModal);
        
        let players = [];
        let currentPlayerId = '';
        let gameCtx = gameCanvas.getContext('2d');
        let minimapCtx = minimapCanvas.getContext('2d');
        let obstacles = [];
        let weapons = [];
        let mapWidth = 2000;
        let mapHeight = 1500;
        
        let keys = {};
        let moveSpeed = 2; // –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º
        let moveInterval;
        let mouseX = 0;
        let mouseY = 0;
        let attackCooldown = false;
        const attackCooldownTime = 500;
        
        // –°–∏—Å—Ç–µ–º–∞ —Ä—ã–≤–∫–æ–≤
        let dashCooldown = false;
        let dashCooldownTime = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –ö–î
        let dashDistance = 80; // –¥–∏—Å—Ç–∞–Ω—Ü–∏—è —Ä—ã–≤–∫–∞ (—É–º–µ–Ω—å—à–µ–Ω–∞)
        let dashSpeed = 7; // —Å–∫–æ—Ä–æ—Å—Ç—å —Ä—ã–≤–∫–∞ (–µ—â—ë –º–µ–Ω—å—à–µ)
        let dashStartTime = 0;
        let isDashing = false;
        let dashTargetX = 0;
        let dashTargetY = 0;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞—Ä–∞
        let attackAnimation = {
            isActive: false,
            startTime: 0,
            duration: 300,
            angle: 0,
            swingDirection: 1
        };
        
        // –ê–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞—Ä–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
        let playerAttackAnimations = new Map();
        
        // –ß–∞—Å—Ç–∏—Ü—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        let particles = [];
        
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∫–∞–º–µ—Ä—ã ---
        let camX = 0, camY = 0;
        let camTargetX = 0, camTargetY = 0;
        const camSmooth = 0.12; // –ß–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –ø–ª–∞–≤–Ω–µ–µ
        // ---
        
        // --- –î–û–ë–ê–í–õ–Ø–ï–ú –ö–î –î–õ–Ø –û–†–£–ñ–ò–Ø ---
        // –ü—Ä–∏ —Å–ø–∞–≤–Ω–µ –æ—Ä—É–∂–∏—è (–∏ –ø—Ä–∏ –ø–æ–¥–±–æ—Ä–µ) –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ cooldown
        function getWeaponCooldown(type) {
            if (type === 'knife') return 400;
            if (type === 'greatsword') return 900;
            return 600; // –æ–±—ã—á–Ω—ã–π –º–µ—á
        }
        // ---
        
        let nextAttackTime = 0; // –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
        
        // --- –ù–ê–°–¢–†–û–ô–ö–ò –ò–ì–†–´ ---
        let gameSettings = {
            damage: 3,
            range: 80,
            knifeDamage: 2,
            knifeRange: 60,
            greatswordDamage: 5,
            greatswordRange: 110
        };

        function applySettingsToWeapon(weapon) {
            if (!weapon) return;
            if (weapon.type === 'knife') {
                weapon.damage = gameSettings.knifeDamage;
                weapon.range = gameSettings.knifeRange;
            } else if (weapon.type === 'greatsword') {
                weapon.damage = gameSettings.greatswordDamage;
                weapon.range = gameSettings.greatswordRange;
            } else {
                weapon.damage = gameSettings.damage;
                weapon.range = gameSettings.range;
            }
        }

        function applySettingsToAllWeapons() {
            // –ù–∞ –∫–∞—Ä—Ç–µ
            weapons.forEach(applySettingsToWeapon);
            // –£ –∏–≥—Ä–æ–∫–æ–≤
            players.forEach(p => applySettingsToWeapon(p.weapon));
            // –£ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è)
            const me = players.find(p => p.id === currentPlayerId);
            if (me && me.weapon) applySettingsToWeapon(me.weapon);
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (typeof updateGame === 'function') updateGame();
        }

        // --- –ú–û–î–ê–õ–ö–ê –ù–ê–°–¢–†–û–ï–ö ---
        const settingsModal = document.createElement('div');
        settingsModal.style.display = 'none';
        settingsModal.style.position = 'fixed';
        settingsModal.style.top = '0';
        settingsModal.style.left = '0';
        settingsModal.style.width = '100vw';
        settingsModal.style.height = '100vh';
        settingsModal.style.background = 'rgba(0,0,0,0.85)';
        settingsModal.style.zIndex = '2000';
        settingsModal.style.justifyContent = 'center';
        settingsModal.style.alignItems = 'center';
        settingsModal.style.transition = 'opacity 0.25s cubic-bezier(.4,2,.6,1), transform 0.25s cubic-bezier(.4,2,.6,1)';
        settingsModal.style.opacity = '0';
        settingsModal.innerHTML = `
          <div id="settings-content" style="background:#222;padding:32px 24px 24px 24px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 8px 32px #000a;display:flex;flex-direction:column;gap:18px;align-items:center;position:relative;transform:scale(0.95);transition:opacity 0.25s, transform 0.25s;">
            <div id="settings-close-x" style="position:absolute;top:10px;right:14px;font-size:22px;color:#00bfff;cursor:pointer;user-select:none;">‚úï</div>
            <h2 style="color:#00bfff;margin:0 0 10px 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>
            <div style="width:100%;height:1px;background:#333;margin:4px 0 10px 0;"></div>
            <label style="color:#fff;">–£—Ä–æ–Ω –º–µ—á–∞: <input id="set-damage" type="number" min="1" max="99" value="3" style="width:60px;padding:3px 6px;border-radius:5px;border:1px solid #444;outline:none;transition:box-shadow 0.2s;"></label>
            <label style="color:#fff;">–†–∞–¥–∏—É—Å –º–µ—á–∞: <input id="set-range" type="number" min="10" max="200" value="80" style="width:60px;padding:3px 6px;border-radius:5px;border:1px solid #444;outline:none;transition:box-shadow 0.2s;"></label>
            <div style="width:100%;height:1px;background:#333;margin:8px 0 2px 0;"></div>
            <label style="color:#fff;">–£—Ä–æ–Ω –Ω–æ–∂–∞: <input id="set-knife-damage" type="number" min="1" max="99" value="2" style="width:60px;padding:3px 6px;border-radius:5px;border:1px solid #444;outline:none;transition:box-shadow 0.2s;"></label>
            <label style="color:#fff;">–†–∞–¥–∏—É—Å –Ω–æ–∂–∞: <input id="set-knife-range" type="number" min="10" max="200" value="60" style="width:60px;padding:3px 6px;border-radius:5px;border:1px solid #444;outline:none;transition:box-shadow 0.2s;"></label>
            <div style="width:100%;height:1px;background:#333;margin:8px 0 2px 0;"></div>
            <label style="color:#fff;">–£—Ä–æ–Ω –¥–≤—É—Ä—É—á–Ω–æ–≥–æ: <input id="set-greatsword-damage" type="number" min="1" max="99" value="5" style="width:60px;padding:3px 6px;border-radius:5px;border:1px solid #444;outline:none;transition:box-shadow 0.2s;"></label>
            <label style="color:#fff;">–†–∞–¥–∏—É—Å –¥–≤—É—Ä—É—á–Ω–æ–≥–æ: <input id="set-greatsword-range" type="number" min="10" max="200" value="110" style="width:60px;padding:3px 6px;border-radius:5px;border:1px solid #444;outline:none;transition:box-shadow 0.2s;"></label>
            <button id="close-settings" style="margin-top:18px;padding:8px 24px;background:#00bfff;color:#fff;border:none;border-radius:6px;font-size:16px;cursor:pointer;box-shadow:0 2px 8px #0005;">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        `;
        document.body.appendChild(settingsModal);

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è
        function openSettingsModal() {
            document.getElementById('set-damage').value = gameSettings.damage;
            document.getElementById('set-range').value = gameSettings.range;
            document.getElementById('set-knife-damage').value = gameSettings.knifeDamage;
            document.getElementById('set-knife-range').value = gameSettings.knifeRange;
            document.getElementById('set-greatsword-damage').value = gameSettings.greatswordDamage;
            document.getElementById('set-greatsword-range').value = gameSettings.greatswordRange;
            settingsModal.style.display = 'flex';
            setTimeout(()=>{
                settingsModal.style.opacity = '1';
                document.getElementById('settings-content').style.opacity = '1';
                document.getElementById('settings-content').style.transform = 'scale(1)';
            }, 10);
        }
        function closeSettingsModal() {
            settingsModal.style.opacity = '0';
            document.getElementById('settings-content').style.opacity = '0.7';
            document.getElementById('settings-content').style.transform = 'scale(0.95)';
            setTimeout(()=>{settingsModal.style.display = 'none';}, 220);
        }
        document.getElementById('close-settings').onclick = closeSettingsModal;
        document.getElementById('settings-close-x').onclick = closeSettingsModal;

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏–Ω–ø—É—Ç–æ–≤ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
        ['set-damage','set-range','set-knife-damage','set-knife-range','set-greatsword-damage','set-greatsword-range'].forEach(id => {
            const el = document.getElementById(id);
            el.onfocus = () => { el.style.boxShadow = '0 0 0 2px #00bfff'; };
            el.onblur = () => { el.style.boxShadow = 'none'; };
            el.style.cursor = 'pointer';
            el.oninput = function() {
                gameSettings.damage = +document.getElementById('set-damage').value;
                gameSettings.range = +document.getElementById('set-range').value;
                gameSettings.knifeDamage = +document.getElementById('set-knife-damage').value;
                gameSettings.knifeRange = +document.getElementById('set-knife-range').value;
                gameSettings.greatswordDamage = +document.getElementById('set-greatsword-damage').value;
                gameSettings.greatswordRange = +document.getElementById('set-greatsword-range').value;
                applySettingsToAllWeapons();
            };
        });
        // ---

        // --- –û–¢–ö–†–´–¢–ò–ï –ù–ê–°–¢–†–û–ï–ö –ü–û –°–õ–û–í–£ ---
        chatInput.addEventListener('keypress', (e) => {
            if (e.code === 'Enter') {
                if (chatInput.value.trim().toLowerCase() === '–ø–∏—Å—é–Ω') {
                    openSettingsModal();
                    chatInput.value = '';
                    e.preventDefault();
                    return;
                }
                sendMessage();
            }
        });
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

        // –ü—Ä–∏ —Å–ø–∞–≤–Ω–µ/–ø–æ–¥–±–æ—Ä–µ –æ—Ä—É–∂–∏—è —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
        socket.on('gameState', (data) => {
            // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
            weapons.forEach(w => { w.cooldown = getWeaponCooldown(w.type); applySettingsToWeapon(w); });
            // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
            players = data.players || [];
            if (data.yourId !== null && data.yourId !== undefined) {
                currentPlayerId = data.yourId;
            }
        });
        socket.on('weaponSpawned', (weapon) => {
            applySettingsToWeapon(weapon);
            weapons.push(weapon);
        });
        socket.on('weaponPickedUp', (data) => {
            // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
            if (data.player && data.player.weapon) {
                data.player.weapon.cooldown = getWeaponCooldown(data.player.weapon.type);
                applySettingsToWeapon(data.player.weapon);
            }
            // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
        });
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

        function joinGame() {
            const nickname = nicknameInput.value.trim();
            if (!nickname || nickname.length < 2) {
                nicknameError.textContent = 'Nickname must be at least 2 characters long';
                return;
            }
            
            socket = io();
            
            socket.on('connect', () => {
                socket.emit('setNickname', nickname);
            });
            
            socket.on('gameState', (data) => {
                players = data.players || [];
                if (data.yourId !== null && data.yourId !== undefined) {
                    currentPlayerId = data.yourId;
                }
                obstacles = data.obstacles || [];
                weapons = data.weapons || [];
                mapWidth = data.mapWidth || 2000;
                mapHeight = data.mapHeight || 1500;
                
                nicknameModal.style.display = 'none';
                gameContainer.style.display = 'flex';
                
                startGame();
                
                // –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–¥ –¥–ª—è –æ—Ä—É–∂–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
                weapons.forEach(w => { w.cooldown = getWeaponCooldown(w.type); applySettingsToWeapon(w); });
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                const me = players.find(p => p.id === currentPlayerId);
                if (me && typeof me.speed === 'number') {
                    moveSpeed = me.speed;
                }
            });
            
            socket.on('nicknameError', (error) => {
                nicknameError.textContent = error;
            });
            
            socket.on('playerJoined', (player) => {
                players.push(player);
                addChatMessage('System', `${player.name} joined the game`);
            });
            
            socket.on('playerLeft', (playerId) => {
                players = players.filter(p => p.id !== playerId);
                addChatMessage('System', 'A player left the game');
            });
            
            socket.on('playerMoved', (data) => {
                const player = players.find(p => p.id === data.id);
                if (player) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞—Å—Ç—Ä—è–ª –ª–∏ –∏–≥—Ä–æ–∫ –≤–æ –≤—Ä–µ–º—è —Ä—ã–≤–∫–∞
                    if (data.id === currentPlayerId && isDashing) {
                        const dx = data.x - player.x;
                        const dy = data.y - player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ —Å–¥–≤–∏–Ω—É–ª—Å—è –∏–ª–∏ —Å–¥–≤–∏–Ω—É–ª—Å—è –æ—á–µ–Ω—å –º–∞–ª–æ, –∑–Ω–∞—á–∏—Ç —Ä—ã–≤–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                        if (distance < 2) {
                            isDashing = false; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ä—ã–≤–æ–∫
                        }
                    }
                    
                    player.x = data.x;
                    player.y = data.y;
                }
            });
            
            socket.on('playerRotated', (data) => {
                const player = players.find(p => p.id === data.id);
                if (player) {
                    player.rotation = data.rotation;
                }
            });
            
            socket.on('chatMessage', (message) => {
                addChatMessage(message.playerName, message.message);
            });
            
            socket.on('weaponAttack', (data) => {
                // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è –∞—Ç–∞–∫–∏ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                const attacker = players.find(p => p.id === data.attackerId);
                if (attacker && attacker.id !== currentPlayerId) {
                    createAttackParticles(attacker.x, attacker.y, attacker.rotation || 0);
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É–¥–∞—Ä–∞ –¥–ª—è –∞—Ç–∞–∫—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                    playerAttackAnimations.set(data.attackerId, {
                        isActive: true,
                        startTime: Date.now(),
                        duration: 300,
                        swingDirection: Math.random() > 0.5 ? 1 : -1
                    });
                    // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ:
                    data.attackedPlayers.forEach(attacked => {
                        const player = players.find(p => p.id === attacked.id);
                        if (player) {
                            player.health = attacked.newHealth;
                        }
                    });
                }
            });
            
                    socket.on('playerDied', (data) => {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ playerDied:', data);
            addChatMessage('System', data.message);
            
            // –ï—Å–ª–∏ —É–º–µ—Ä —Ç–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è
            if (data.playerId === currentPlayerId) {
                console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞');
                showRespawnModal();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–º–µ—Ä—à–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            const playerIndex = players.findIndex(p => p.id === data.playerId);
            if (playerIndex !== -1) {
                players[playerIndex].isDead = true;
                players[playerIndex].health = 0;
                console.log('–ò–≥—Ä–æ–∫ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –º–µ—Ä—Ç–≤—ã–π:', players[playerIndex]);
            }
        });
            
            socket.on('weaponSpawned', (weapon) => {
                applySettingsToWeapon(weapon);
                weapons.push(weapon);
            });
            
            socket.on('weaponPickedUp', (data) => {
                // –£–¥–∞–ª—è–µ–º –æ—Ä—É–∂–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞
                const weaponsBefore = weapons.length;
                weapons = weapons.filter(w => w.id !== data.weaponId);
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ —Å –æ—Ä—É–∂–∏–µ–º
                const playerIndex = players.findIndex(p => p.id === data.playerId);
                if (playerIndex !== -1 && data.player) {
                    const oldPlayer = players[playerIndex];
                    players[playerIndex] = { ...oldPlayer, ...data.player };
                }
                if (data.player && data.player.weapon) {
                    data.player.weapon.cooldown = getWeaponCooldown(data.player.weapon.type);
                    applySettingsToWeapon(data.player.weapon);
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                if (data.playerId === currentPlayerId && data.player && typeof data.player.speed === 'number') {
                    moveSpeed = data.player.speed;
                }
            });
            
            socket.on('weaponDropped', (data) => {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–æ—à–µ–Ω–Ω–æ–µ –æ—Ä—É–∂–∏–µ –Ω–∞ –∫–∞—Ä—Ç—É
                if (data.weapon) {
                    applySettingsToWeapon(data.weapon);
                    weapons.push(data.weapon);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ –±–µ–∑ –æ—Ä—É–∂–∏—è
                const playerIndex = players.findIndex(p => p.id === data.playerId);
                if (playerIndex !== -1 && data.player) {
                    const oldPlayer = players[playerIndex];
                    players[playerIndex] = { ...oldPlayer, ...data.player };
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                if (data.playerId === currentPlayerId && data.player && typeof data.player.speed === 'number') {
                    moveSpeed = data.player.speed;
                }
            });
            
            socket.on('weaponBroken', (data) => {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ –∫–æ–≥–¥–∞ –æ—Ä—É–∂–∏–µ –ª–æ–º–∞–µ—Ç—Å—è
                const playerIndex = players.findIndex(p => p.id === data.playerId);
                if (playerIndex !== -1 && data.player) {
                    players[playerIndex] = { ...players[playerIndex], ...data.player };
                    delete players[playerIndex].weapon;
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                if (data.playerId === currentPlayerId && data.player && typeof data.player.speed === 'number') {
                    moveSpeed = data.player.speed;
                }
            });
            
            socket.on('playerUpdated', (data) => {
                players = players.map(p => p.id === data.playerId ? { ...data.player } : p);
                if (data.playerId === currentPlayerId) {
                    const me = players.find(p => p.id === currentPlayerId);
                    console.clear();
                    console.log('DURABILITY:', me && me.weapon ? me.weapon.durability : '–Ω–µ—Ç –º–µ—á–∞');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                    if (me && typeof me.speed === 'number') {
                        moveSpeed = me.speed;
                    }
                }
            });
            
            socket.on('playerDashed', (data) => {
                // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Ä—ã–≤–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                const player = players.find(p => p.id === data.id);
                if (player && data.id !== currentPlayerId) {
                    createDashEffect(data.x, data.y);
                }
            });
            
            socket.on('playerRespawned', (data) => {
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ playerRespawned:', data);
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ–∑—Ä–æ–¥–∏–≤—à–µ–≥–æ—Å—è –∏–≥—Ä–æ–∫–∞
                const playerIndex = players.findIndex(p => p.id === data.playerId);
                if (playerIndex !== -1 && data.player) {
                    players[playerIndex] = { ...players[playerIndex], ...data.player };
                    console.log('–ò–≥—Ä–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω:', players[playerIndex]);
                }
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫, —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
                if (data.playerId === currentPlayerId) {
                    console.log('–°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è');
                    hideRespawnModal();
                    if (data.player && typeof data.player.speed === 'number') {
                        moveSpeed = data.player.speed;
                    }
                }
            });
            
            socket.on('leaderboardUpdate', (leaderboard) => {
                updateLeaderboard(leaderboard);
            });
        }
        
        function startGame() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä canvas
            resizeGameCanvas();
            
            // Keyboard events
            document.addEventListener('keydown', (e) => {
                keys[e.code.toLowerCase()] = true;
                
                // –†—ã–≤–æ–∫ –ø–æ Shift
                if ((e.code === 'ShiftLeft' || e.code === 'ShiftRight') && !dashCooldown && !isDashing) {
                    const currentPlayer = players.find(p => p.id === currentPlayerId);
                    if (currentPlayer && !currentPlayer.isDead) {
                        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä—ã–≤–∫–∞ (–∫ –∫—É—Ä—Å–æ—Ä—É –º—ã—à–∏)
                        const dx = mouseX - (currentPlayer.x - camX);
                        const dy = mouseY - (currentPlayer.y - camY);
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance > 0) {
                            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–µ–∫—Ç–æ—Ä –∏ —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é —Ä—ã–≤–∫–∞
                            const normalizedDx = (dx / distance) * dashDistance;
                            const normalizedDy = (dy / distance) * dashDistance;
                            
                            dashTargetX = currentPlayer.x + normalizedDx;
                            dashTargetY = currentPlayer.y + normalizedDy;
                            
                            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä—ã–≤–æ–∫ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –∫–∞—Ä—Ç—ã
                            dashTargetX = Math.max(25, Math.min(dashTargetX, mapWidth - 25));
                            dashTargetY = Math.max(25, Math.min(dashTargetY, mapHeight - 25));
                            
                            isDashing = true;
                            dashCooldown = true;
                            dashStartTime = Date.now(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ö–î —Å—Ä–∞–∑—É
                            
                            // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Ä—ã–≤–∫–∞
                            createDashEffect(currentPlayer.x, currentPlayer.y);
                            
                            // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ —Ä—ã–≤–∫–µ
                            socket.emit('playerDash', {
                                x: currentPlayer.x,
                                y: currentPlayer.y,
                                targetX: dashTargetX,
                                targetY: dashTargetY
                            });
                        }
                    }
                }
                
                // Weapon pickup
                if (e.code === 'KeyE') {
                    const currentPlayer = players.find(p => p.id === currentPlayerId);
                    if (currentPlayer && !currentPlayer.isDead) {
                        weapons.forEach(weapon => {
                            const distance = Math.sqrt(
                                Math.pow(currentPlayer.x - weapon.x, 2) + Math.pow(currentPlayer.y - weapon.y, 2)
                            );
                            if (distance < 50) { // –£–≤–µ–ª–∏—á–∏–ª —Ä–∞–¥–∏—É—Å –ø–æ–¥–±–æ—Ä–∞
                                socket.emit('pickupWeapon', weapon.id);
                            }
                        });
                    }
                }
                
                // Weapon drop
                if (e.code === 'KeyQ') {
                    const currentPlayer = players.find(p => p.id === currentPlayerId);
                    if (currentPlayer && currentPlayer.weapon && !currentPlayer.isDead) {
                        socket.emit('dropWeapon');
                    }
                }
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.code.toLowerCase()] = false;
            });
            
            // Mouse events
            gameCanvas.addEventListener('mousemove', (e) => {
                const rect = gameCanvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            gameCanvas.addEventListener('click', () => {
                const currentPlayer = players.find(p => p.id === currentPlayerId);
                if (!currentPlayer || !currentPlayer.weapon || currentPlayer.isDead) return;
                const now = Date.now();
                const weaponCooldown = currentPlayer.weapon.cooldown || getWeaponCooldown(currentPlayer.weapon.type);
                if (now < nextAttackTime || attackCooldown) return; // –∫–¥ –Ω–µ –ø—Ä–æ—à–ª–æ –∏–ª–∏ —É–∂–µ –∞—Ç–∞–∫—É–µ–º
                nextAttackTime = now + weaponCooldown;
                attackCooldown = true;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É–¥–∞—Ä–∞
                attackAnimation.isActive = true;
                attackAnimation.startTime = Date.now();
                attackAnimation.angle = currentPlayer.rotation || 0;
                attackAnimation.swingDirection = Math.random() > 0.5 ? 1 : -1;
                
                // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã —É–¥–∞—Ä–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                createAttackParticles(currentPlayer.x, currentPlayer.y, currentPlayer.rotation || 0);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω–Ω—É—é —Ç—Ä—è—Å–∫—É –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
                gameCanvas.style.transform = 'translate(2px, 2px)';
                setTimeout(() => {
                    gameCanvas.style.transform = 'translate(0px, 0px)';
                }, 50);
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º weaponAttack, durability:', currentPlayer.weapon.durability);
                socket.emit('weaponAttack');
                setTimeout(() => {
                    attackCooldown = false;
                }, attackCooldownTime);
            });
            
            // Chat input
            chatInput.addEventListener('keypress', (e) => {
                if (e.code === 'Enter') {
                    sendMessage();
                }
            });
            
            // Start game loop
            moveInterval = setInterval(updateGame, 16);
            requestAnimationFrame(renderGame);
        }
        
        function updateGame() {
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            if (!currentPlayer) return;
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –º–µ—Ä—Ç–≤, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
            if (currentPlayer.isDead) return;
            
            let moved = false;
            let newX = currentPlayer.x;
            let newY = currentPlayer.y;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä—ã–≤–∫–∞
            if (isDashing) {
                const dx = dashTargetX - currentPlayer.x;
                const dy = dashTargetY - currentPlayer.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) {
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä—ã–≤–æ–∫
                    const normalizedDx = (dx / distance) * dashSpeed;
                    const normalizedDy = (dy / distance) * dashSpeed;
                    
                    newX = currentPlayer.x + normalizedDx;
                    newY = currentPlayer.y + normalizedDy;
                    moved = true;
                } else {
                    // –†—ã–≤–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω
                    isDashing = false;
                    newX = dashTargetX;
                    newY = dashTargetY;
                    moved = true;
                }
            } else {
                // –û–±—ã—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                if (keys['keyw'] || keys['arrowup']) {
                    newY -= moveSpeed;
                    moved = true;
                }
                if (keys['keys'] || keys['arrowdown']) {
                    newY += moveSpeed;
                    moved = true;
                }
                if (keys['keya'] || keys['arrowleft']) {
                    newX -= moveSpeed;
                    moved = true;
                }
                if (keys['keyd'] || keys['arrowright']) {
                    newX += moveSpeed;
                    moved = true;
                }
            }
            
            if (moved) {
                socket.emit('playerMove', { x: newX, y: newY });
            }
            
            // Update rotation (—É—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã)
            const dx = mouseX - (currentPlayer.x - camX);
            const dy = mouseY - (currentPlayer.y - camY);
            const rotation = Math.atan2(dy, dx) + Math.PI / 2;
            socket.emit('playerRotate', { rotation });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É–¥–∞—Ä–∞
            if (attackAnimation.isActive) {
                const elapsed = Date.now() - attackAnimation.startTime;
                if (elapsed >= attackAnimation.duration) {
                    attackAnimation.isActive = false;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞—Ä–æ–≤ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            playerAttackAnimations.forEach((animation, playerId) => {
                const elapsed = Date.now() - animation.startTime;
                if (elapsed >= animation.duration) {
                    playerAttackAnimations.delete(playerId);
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—ã
            updateParticles();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ö–î —Ä—ã–≤–∫–∞
            if (dashCooldown) {
                const elapsed = Date.now() - dashStartTime;
                if (elapsed >= dashCooldownTime) {
                    dashCooldown = false;
                }
            }
            
            // Update player count
            playerCount.textContent = players.length;
        }
        
        function renderGame() {
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã canvas
            const canvasWidth = gameCanvas.width;
            const canvasHeight = gameCanvas.height;
            // –ù–∞–π—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            // –ö—É–¥–∞ —Ö–æ—Ç–∏–º –∫–∞–º–µ—Ä—É
            if (currentPlayer) {
                camTargetX = currentPlayer.x - canvasWidth / 2;
                camTargetY = currentPlayer.y - canvasHeight / 2;
                camTargetX = Math.max(0, Math.min(camTargetX, mapWidth - canvasWidth));
                camTargetY = Math.max(0, Math.min(camTargetY, mapHeight - canvasHeight));
            }
            // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            camX += (camTargetX - camX) * camSmooth;
            camY += (camTargetY - camY) * camSmooth;
            // –û—á–∏—Å—Ç–∏—Ç—å –∫–∞–Ω–≤–∞—Å
            gameCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            gameCtx.fillStyle = '#0a0a0a';
            gameCtx.fillRect(0, 0, canvasWidth, canvasHeight);
            // –°–µ—Ç–∫–∞
            gameCtx.strokeStyle = '#222';
            gameCtx.lineWidth = 1;
            for (let x = 0; x <= canvasWidth; x += 40) {
                gameCtx.beginPath();
                gameCtx.moveTo(x, 0);
                gameCtx.lineTo(x, canvasHeight);
                gameCtx.stroke();
            }
            for (let y = 0; y <= canvasHeight; y += 40) {
                gameCtx.beginPath();
                gameCtx.moveTo(0, y);
                gameCtx.lineTo(canvasWidth, y);
                gameCtx.stroke();
            }
            // –†–∞–¥–∏—É—Å—ã —É–¥–∞—Ä–∞ (–Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ)
            players.forEach(player => {
                const isCurrentPlayer = player.id === currentPlayerId;
                if (isCurrentPlayer && player.weapon) {
                    const range = player.weapon.range || 80;
                    const angle = player.rotation || 0;
                    
                    gameCtx.save();
                    gameCtx.globalAlpha = 0.15;
                    
                    // –†–∏—Å—É–µ–º —Å–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏ (90 –≥—Ä–∞–¥—É—Å–æ–≤)
                    gameCtx.beginPath();
                    gameCtx.moveTo(player.x - camX, player.y - camY);
                    const sectorAngle = angle - Math.PI / 2;
                    gameCtx.arc(player.x - camX, player.y - camY, range, sectorAngle - Math.PI/4, sectorAngle + Math.PI/4);
                    gameCtx.closePath();
                    gameCtx.fillStyle = '#1a1a1a';
                    gameCtx.fill();
                    
                    gameCtx.restore();
                }
            });
            // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            obstacles.forEach(obstacle => {
                gameCtx.fillStyle = obstacle.type === 'wall' ? '#666' : 
                                   obstacle.type === 'block' ? '#444' : '#2a5a2a';
                gameCtx.fillRect(
                    obstacle.x - camX,
                    obstacle.y - camY,
                    obstacle.width,
                    obstacle.height
                );
            });
            // –û—Ä—É–∂–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ
            weapons.forEach(weapon => {
                gameCtx.save();
                // –≠—Ñ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –æ—Ä—É–∂–∏—è
                const pulse = 0.7 + 0.3 * Math.sin(Date.now() / 200);
                gameCtx.globalAlpha = pulse;
                // –†–∏—Å—É–µ–º –ø–æ —Ç–∏–ø—É
                if (weapon.type === 'knife') {
                    gameCtx.fillStyle = '#aaa';
                    gameCtx.fillRect(weapon.x - 10 - camX, weapon.y - 1 - camY, 20, 2);
                    gameCtx.fillStyle = '#888';
                    gameCtx.fillRect(weapon.x + 10 - camX, weapon.y - 2 - camY, 4, 4);
                } else if (weapon.type === 'greatsword') {
                    gameCtx.fillStyle = '#444';
                    gameCtx.fillRect(weapon.x - 22 - camX, weapon.y - 3 - camY, 44, 6);
                    gameCtx.fillStyle = '#b97a56';
                    gameCtx.fillRect(weapon.x + 18 - camX, weapon.y - 5 - camY, 10, 10);
                } else { // –º–µ—á
                    gameCtx.fillStyle = '#8B4513';
                    gameCtx.fillRect(weapon.x - 15 - camX, weapon.y - 2 - camY, 30, 4);
                    gameCtx.fillStyle = '#654321';
                    gameCtx.fillRect(weapon.x + 15 - camX, weapon.y - 3 - camY, 8, 6);
                }
                // –¢–µ–∫—Å—Ç –Ω–∞–∑–≤–∞–Ω–∏—è
                gameCtx.globalAlpha = 1.0;
                gameCtx.fillStyle = '#FFD700';
                gameCtx.font = '12px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText(weapon.name, weapon.x - camX, weapon.y - 15 - camY);
                gameCtx.restore();
            });
            
            // –ò–≥—Ä–æ–∫–∏
            players.forEach(player => {
                const isCurrentPlayer = player.id === currentPlayerId;
                const px = player.x - camX;
                const py = player.y - camY;
                
                gameCtx.save();
                gameCtx.translate(px, py);
                gameCtx.rotate(player.rotation || 0);
                // –¢–µ–Ω—å –ø–æ–¥ –∏–≥—Ä–æ–∫–æ–º
                gameCtx.save();
                gameCtx.globalAlpha = 0.25;
                gameCtx.fillStyle = '#000';
                gameCtx.beginPath();
                gameCtx.ellipse(0, 8, 12, 5, 0, 0, 2 * Math.PI);
                gameCtx.fill();
                gameCtx.restore();
                // –°–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–ª—è —É–º–µ—Ä—à–∏—Ö)
                if (isCurrentPlayer && !player.isDead) {
                    gameCtx.save();
                    gameCtx.shadowColor = '#00f0ff';
                    gameCtx.shadowBlur = 18;
                    gameCtx.beginPath();
                    gameCtx.arc(0, 0, 13, 0, 2 * Math.PI);
                    gameCtx.strokeStyle = '#00f0ff';
                    gameCtx.lineWidth = 2;
                    gameCtx.stroke();
                    gameCtx.restore();
                }
                // –¢–µ–ª–æ
                gameCtx.beginPath();
                gameCtx.arc(0, 0, 10, 0, 2 * Math.PI);
                // –¶–≤–µ—Ç –∏–≥—Ä–æ–∫–∞ (—Å–µ—Ä—ã–π –µ—Å–ª–∏ –º–µ—Ä—Ç–≤)
                if (player.isDead) {
                    gameCtx.fillStyle = '#666666';
                    gameCtx.globalAlpha = 0.7;
                } else {
                    gameCtx.fillStyle = player.color;
                }
                gameCtx.fill();
                // –ë–æ—Ä–¥–µ—Ä
                if (player.isDead) {
                    gameCtx.strokeStyle = '#666666';
                    gameCtx.lineWidth = 1;
                } else {
                    gameCtx.strokeStyle = isCurrentPlayer ? '#ffffff' : '#333';
                    gameCtx.lineWidth = isCurrentPlayer ? 3 : 1;
                }
                gameCtx.stroke();
                // –ì–ª–∞–∑–∞
                if (player.isDead) {
                    gameCtx.fillStyle = '#333333';
                } else {
                    gameCtx.fillStyle = '#ffffff';
                }
                gameCtx.beginPath();
                gameCtx.arc(-4, -3, 2, 0, 2 * Math.PI);
                gameCtx.fill();
                gameCtx.beginPath();
                gameCtx.arc(4, -3, 2, 0, 2 * Math.PI);
                gameCtx.fill();
                
                // –û—Ä—É–∂–∏–µ –≤ —Ä—É–∫–∞—Ö (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–ª—è —É–º–µ—Ä—à–∏—Ö)
                if (player.weapon && !player.isDead) {
                    gameCtx.save();
                    gameCtx.translate(0, -12);
                    let w = player.weapon;
                    let weaponRotation = 0;
                    if (isCurrentPlayer && attackAnimation.isActive && !player.isDead) {
                        const elapsed = Date.now() - attackAnimation.startTime;
                        const progress = elapsed / attackAnimation.duration;
                        weaponRotation = Math.sin(progress * Math.PI) * 0.5 * attackAnimation.swingDirection;
                    } else if (playerAttackAnimations.has(player.id) && !player.isDead) {
                        const animation = playerAttackAnimations.get(player.id);
                        const elapsed = Date.now() - animation.startTime;
                        const progress = elapsed / animation.duration;
                        weaponRotation = Math.sin(progress * Math.PI) * 0.5 * animation.swingDirection;
                    }
                    if (isCurrentPlayer && attackAnimation.isActive && !player.isDead) {
                        gameCtx.shadowColor = '#FF4500';
                        gameCtx.shadowBlur = 15;
                    }
                    gameCtx.rotate(weaponRotation);
                    // –†–∏—Å—É–µ–º –ø–æ —Ç–∏–ø—É
                    if (w.type === 'knife') {
                        gameCtx.fillStyle = '#aaa';
                        gameCtx.fillRect(-10, -1, 20, 2);
                        gameCtx.fillStyle = '#888';
                        gameCtx.fillRect(10, -2, 4, 4);
                    } else if (w.type === 'greatsword') {
                        gameCtx.fillStyle = '#444';
                        gameCtx.fillRect(-22, -3, 44, 6);
                        gameCtx.fillStyle = '#b97a56';
                        gameCtx.fillRect(18, -5, 10, 10);
                    } else { // –º–µ—á
                        gameCtx.fillStyle = '#8B4513';
                        gameCtx.fillRect(-15, -2, 30, 4);
                        gameCtx.fillStyle = '#654321';
                        gameCtx.fillRect(15, -3, 8, 6);
                    }
                    gameCtx.shadowBlur = 0;
                    gameCtx.restore();
                }
                
                gameCtx.restore();
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
                const healthBarWidth = 30;
                const healthBarHeight = 4;
                const healthBarY = py - 35;
                
                // –§–æ–Ω –ø–æ–ª–æ—Å–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
                gameCtx.fillStyle = '#333333';
                gameCtx.fillRect(px - healthBarWidth/2, healthBarY, healthBarWidth, healthBarHeight);
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–æ—Å–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
                const healthPercentage = (player.health || 10) / (player.maxHealth || 10);
                const healthFillWidth = healthBarWidth * healthPercentage;
                
                // –î–ª—è —É–º–µ—Ä—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ö–ø–±–∞—Ä–∞
                if (!player.isDead) {
                    gameCtx.fillStyle = healthPercentage > 0.5 ? '#00ff00' : healthPercentage > 0.25 ? '#ffff00' : '#ff0000';
                    gameCtx.fillRect(px - healthBarWidth/2, healthBarY, healthFillWidth, healthBarHeight);
                }
                
                // –ì—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–æ—Å–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
                if (player.isDead) {
                    gameCtx.strokeStyle = '#666666';
                } else {
                    gameCtx.strokeStyle = '#ffffff';
                }
                gameCtx.lineWidth = 1;
                gameCtx.strokeRect(px - healthBarWidth/2, healthBarY, healthBarWidth, healthBarHeight);
                
                // –¢–µ–∫—Å—Ç –∑–¥–æ—Ä–æ–≤—å—è
                gameCtx.fillStyle = '#ffffff';
                gameCtx.font = '10px Arial';
                gameCtx.textAlign = 'center';
                if (player.isDead) {
                    gameCtx.fillStyle = '#ff4444';
                    gameCtx.fillText('–ú–ï–†–¢–í', px, healthBarY - 5);
                } else {
                    gameCtx.fillText(`${player.health || 10}/${player.maxHealth || 10}`, px, healthBarY - 5);
                }
                // Fade –¥–ª—è –∏–º–µ–Ω–∏ (–∏–º—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–ª–∞–≤–Ω–æ, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
                let nameAlpha = 1.0;
                if (px < 0 || px > canvasWidth || py < 0 || py > canvasHeight) nameAlpha = 0;
                else if (px < 40 || px > canvasWidth - 40 || py < 30 || py > canvasHeight - 30) nameAlpha = 0.3;
                gameCtx.save();
                gameCtx.globalAlpha = nameAlpha;
                if (player.isDead) {
                    gameCtx.fillStyle = '#666666';
                    gameCtx.globalAlpha = nameAlpha * 0.7;
                } else {
                    gameCtx.fillStyle = '#ffffff';
                }
                gameCtx.font = '12px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText(player.name, px, py - 20);
                gameCtx.globalAlpha = 1.0;
                gameCtx.restore();
                
                // –ü–æ–ª–æ—Å–∫–∞ –∫–¥ (cooldown bar)
                if (isCurrentPlayer && player.weapon && nextAttackTime > Date.now() && !player.isDead) {
                    const cdBarWidth = 30;
                    const cdBarHeight = 4;
                    const cdBarY = py - 28;
                    const weaponCooldown = player.weapon.cooldown || getWeaponCooldown(player.weapon.type);
                    const cdLeft = Math.max(0, nextAttackTime - Date.now());
                    const cdPercent = 1 - cdLeft / weaponCooldown;
                    // –§–æ–Ω
                    gameCtx.fillStyle = '#222';
                    gameCtx.fillRect(px - cdBarWidth/2, cdBarY, cdBarWidth, cdBarHeight);
                    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
                    gameCtx.fillStyle = '#00bfff';
                    gameCtx.fillRect(px - cdBarWidth/2, cdBarY, cdBarWidth * cdPercent, cdBarHeight);
                    // –ì—Ä–∞–Ω–∏—Ü–∞
                    gameCtx.strokeStyle = '#fff';
                    gameCtx.lineWidth = 1;
                    gameCtx.strokeRect(px - cdBarWidth/2, cdBarY, cdBarWidth, cdBarHeight);
                }
            });
            // –†–µ–Ω–¥–µ—Ä–∏–º —á–∞—Å—Ç–∏—Ü—ã
            renderParticles();
            
            // –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞
            renderMinimap();
            renderInventory();
            renderDashCooldown();
            renderPlayerSpeed();
            requestAnimationFrame(renderGame);
        }
        
        function renderMinimap() {
            minimapCtx.fillStyle = '#0a0a0a';
            minimapCtx.fillRect(0, 0, 200, 150);
            
            const scaleX = 200 / mapWidth;
            const scaleY = 150 / mapHeight;
            
            // Draw obstacles on minimap
            obstacles.forEach(obstacle => {
                minimapCtx.fillStyle = '#666';
                minimapCtx.fillRect(
                    obstacle.x * scaleX,
                    obstacle.y * scaleY,
                    obstacle.width * scaleX,
                    obstacle.height * scaleY
                );
            });
            
            // Draw weapons on minimap
            weapons.forEach(weapon => {
                minimapCtx.fillStyle = '#FFD700';
                minimapCtx.beginPath();
                minimapCtx.arc(
                    weapon.x * scaleX,
                    weapon.y * scaleY,
                    1.5,
                    0,
                    2 * Math.PI
                );
                minimapCtx.fill();
            });
            
            // Draw players on minimap
            players.forEach(player => {
                if (player.isDead) {
                    minimapCtx.fillStyle = '#666666';
                    minimapCtx.globalAlpha = 0.5;
                } else {
                    minimapCtx.fillStyle = player.id === currentPlayerId ? '#ffffff' : player.color;
                }
                minimapCtx.beginPath();
                minimapCtx.arc(
                    player.x * scaleX,
                    player.y * scaleY,
                    2,
                    0,
                    2 * Math.PI
                );
                minimapCtx.fill();
                minimapCtx.globalAlpha = 1.0;
            });
        }
        
        function createAttackParticles(x, y, rotation) {
            // –°–º–µ—â–µ–Ω–∏–µ –º–µ—á–∞ –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (–∫–∞–∫ –≤ translate)
            const localOffsetX = 0;
            const localOffsetY = -12;
            // –î–ª–∏–Ω–∞ –º–µ—á–∞ (–æ—Ç translate –¥–æ –∫–æ–Ω—á–∏–∫–∞)
            const swordLength = 30;

            // –°—á–∏—Ç–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ–Ω—á–∏–∫–∞ –º–µ—á–∞
            const tipX = x + Math.cos(rotation) * localOffsetY - Math.sin(rotation) * localOffsetX + Math.cos(rotation) * swordLength;
            const tipY = y + Math.sin(rotation) * localOffsetY + Math.cos(rotation) * localOffsetX + Math.sin(rotation) * swordLength;

            const particleCount = 8;
            for (let i = 0; i < particleCount; i++) {
                const angle = rotation + (Math.random() - 0.5) * Math.PI / 6;
                const speed = 2 + Math.random() * 3;
                const life = 20 + Math.random() * 30;

                particles.push({
                    x: tipX,
                    y: tipY,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: life,
                    maxLife: life,
                    color: `hsl(${Math.random() * 60 + 15}, 100%, 50%)`,
                    size: 2 + Math.random() * 3
                });
            }
        }
        
        function createDashEffect(x, y) {
            // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Ä—ã–≤–∫–∞ - —á–∞—Å—Ç–∏—Ü—ã –≤ —Ñ–æ—Ä–º–µ —Å–ª–µ–¥–∞
            const particleCount = 15;
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 2;
                const life = 30 + Math.random() * 20;

                particles.push({
                    x: x + (Math.random() - 0.5) * 20,
                    y: y + (Math.random() - 0.5) * 20,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: life,
                    maxLife: life,
                    color: `hsl(${200 + Math.random() * 40}, 100%, 70%)`,
                    size: 3 + Math.random() * 4
                });
            }
        }
        
        function updateParticles() {
            particles = particles.filter(particle => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life--;
                particle.vx *= 0.95; // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ
                particle.vy *= 0.95;
                return particle.life > 0;
            });
        }
        
        function renderParticles() {
            particles.forEach(particle => {
                const alpha = particle.life / particle.maxLife;
                gameCtx.save();
                gameCtx.globalAlpha = alpha;
                gameCtx.fillStyle = particle.color;
                gameCtx.beginPath();
                gameCtx.arc(
                    particle.x - camX,
                    particle.y - camY,
                    particle.size * alpha,
                    0,
                    2 * Math.PI
                );
                gameCtx.fill();
                gameCtx.restore();
            });
        }
        
        function updateLeaderboard(leaderboard) {
            const leaderboardList = document.getElementById('leaderboardList');
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<div style="color: #6b7280; font-size: 14px;">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</div>';
                return;
            }
            
            leaderboardList.innerHTML = '';
            leaderboard.forEach(player => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                const rank = document.createElement('div');
                rank.className = 'leaderboard-rank';
                rank.textContent = player.rank;
                
                const color = document.createElement('div');
                color.className = 'leaderboard-player-color';
                color.style.backgroundColor = player.color;
                
                const name = document.createElement('div');
                name.className = 'leaderboard-name';
                name.textContent = player.name;
                
                const kills = document.createElement('div');
                kills.className = 'leaderboard-kills';
                kills.textContent = `${player.kills} üíÄ`;
                
                item.appendChild(rank);
                item.appendChild(color);
                item.appendChild(name);
                item.appendChild(kills);
                leaderboardList.appendChild(item);
            });
        }
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message && socket) {
                socket.emit('chatMessage', message);
                chatInput.value = '';
            }
        }
        
        function addChatMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '5px';
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (sender === 'System') {
                messageDiv.style.fontSize = '11px';
                messageDiv.style.color = '#666';
                messageDiv.style.fontStyle = 'italic';
                messageDiv.innerHTML = `${message}`;
            } else {
                messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function renderInventory() {
            const canvasWidth = gameCanvas.width;
            const canvasHeight = gameCanvas.height;
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            if (!currentPlayer) return;
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –º–µ—Ä—Ç–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–º–µ—Ä—Ç–∏
            if (currentPlayer.isDead) {
                const invX = canvasWidth - 80;
                const invY = canvasHeight - 80;
                gameCtx.save();
                gameCtx.globalAlpha = 0.7;
                gameCtx.fillStyle = '#222';
                gameCtx.fillRect(invX, invY, 64, 64);
                gameCtx.globalAlpha = 1.0;
                gameCtx.fillStyle = '#ff4444';
                gameCtx.font = 'bold 12px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('–ú–ï–†–¢–í', invX + 32, invY + 32);
                gameCtx.restore();
                return;
            }
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª)
            const invX = canvasWidth - 80;
            const invY = canvasHeight - 80;
            gameCtx.clearRect(invX, invY, 64, 64);
            gameCtx.save();
            // –§–æ–Ω –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            gameCtx.globalAlpha = 0.7;
            gameCtx.fillStyle = '#222';
            gameCtx.fillRect(invX, invY, 64, 64);
            gameCtx.globalAlpha = 1.0;

            if (currentPlayer.weapon) {
                // –†–∏—Å—É–µ–º –æ—Ä—É–∂–∏–µ –ø–æ —Ç–∏–ø—É
                gameCtx.save();
                gameCtx.translate(invX + 32, invY + 32);
                let w = currentPlayer.weapon;
                if (w.type === 'knife') {
                    gameCtx.rotate(-0.2);
                    gameCtx.fillStyle = '#aaa';
                    gameCtx.fillRect(-10, -1, 20, 2);
                    gameCtx.fillStyle = '#888';
                    gameCtx.fillRect(10, -2, 4, 4);
                } else if (w.type === 'greatsword') {
                    gameCtx.rotate(0.2);
                    gameCtx.fillStyle = '#444';
                    gameCtx.fillRect(-22, -3, 44, 6);
                    gameCtx.fillStyle = '#b97a56';
                    gameCtx.fillRect(18, -5, 10, 10);
                } else { // –º–µ—á
                    gameCtx.rotate(0.2);
                    gameCtx.fillStyle = '#8B4513';
                    gameCtx.fillRect(-15, -2, 30, 4);
                    gameCtx.fillStyle = '#654321';
                    gameCtx.fillRect(15, -3, 8, 6);
                }
                gameCtx.restore();
                // –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —É—Ä–æ–Ω
                gameCtx.fillStyle = '#fff';
                gameCtx.font = 'bold 12px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText(w.name, invX + 32, invY + 16);
                // –£—Ä–æ–Ω
                gameCtx.fillStyle = '#fff';
                gameCtx.font = 'bold 12px Arial';
                gameCtx.fillText(`–£—Ä–æ–Ω: ${w.damage}`, invX + 32, invY + 30);
                // –í–µ—Å
                gameCtx.fillStyle = '#ffaa00';
                gameCtx.font = 'bold 12px Arial';
                gameCtx.fillText(`–í–µ—Å: ${w.weight}`, invX + 32, invY + 44);
                // –ü—Ä–æ—á–Ω–æ—Å—Ç—å
                gameCtx.fillStyle = '#fff';
                gameCtx.font = 'bold 14px Arial';
                gameCtx.fillText(`${w.durability}/${w.type === 'knife' ? 2 : w.type === 'greatsword' ? 5 : 3}`, invX + 32, invY + 60);
            } else {
                gameCtx.fillStyle = '#888';
                gameCtx.font = 'bold 16px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('–ü—É—Å—Ç–æ', invX + 32, invY + 40);
            }
            gameCtx.restore();
        }
        
        function renderPlayerSpeed() {
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            if (!currentPlayer || currentPlayer.isDead) return;
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ—Ä–æ—Å—Ç–∏ (–ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª, –ø–æ–¥ –ö–î —Ä—ã–≤–∫–∞)
            const speedX = 20;
            const speedY = 80;
            const width = 120;
            const height = 30;
            
            gameCtx.save();
            
            // –§–æ–Ω
            gameCtx.globalAlpha = 0.8;
            gameCtx.fillStyle = '#222';
            gameCtx.fillRect(speedX, speedY, width, height);
            gameCtx.globalAlpha = 1.0;
            
            // –†–∞–º–∫–∞
            gameCtx.strokeStyle = '#00ff00';
            gameCtx.lineWidth = 1;
            gameCtx.strokeRect(speedX, speedY, width, height);
            
            // –¢–µ–∫—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
            gameCtx.fillStyle = '#00ff00';
            gameCtx.font = 'bold 12px Arial';
            gameCtx.textAlign = 'left';
            gameCtx.fillText(`–°–∫–æ—Ä–æ—Å—Ç—å: ${moveSpeed.toFixed(1)}`, speedX + 5, speedY + 20);
            
            gameCtx.restore();
        }
        
        function renderDashCooldown() {
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            if (!currentPlayer || currentPlayer.isDead) return;
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ö–î —Ä—ã–≤–∫–∞ (–ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª)
            const cooldownX = 20;
            const cooldownY = 20;
            const size = 50;
            
            gameCtx.save();
            
            // –§–æ–Ω
            gameCtx.globalAlpha = 0.8;
            gameCtx.fillStyle = '#222';
            gameCtx.fillRect(cooldownX, cooldownY, size, size);
            gameCtx.globalAlpha = 1.0;
            
            // –†–∞–º–∫–∞
            if (isDashing) {
                gameCtx.strokeStyle = '#ffff00';
            } else {
                gameCtx.strokeStyle = dashCooldown ? '#666' : '#00bfff';
            }
            gameCtx.lineWidth = 2;
            gameCtx.strokeRect(cooldownX, cooldownY, size, size);
            
            // –ò–∫–æ–Ω–∫–∞ —Ä—ã–≤–∫–∞
            if (isDashing) {
                gameCtx.fillStyle = '#ffff00';
                gameCtx.font = 'bold 20px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('‚ö°', cooldownX + size/2, cooldownY + size/2 + 5);
            } else {
                gameCtx.fillStyle = dashCooldown ? '#666' : '#00bfff';
                gameCtx.font = 'bold 20px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('‚ö°', cooldownX + size/2, cooldownY + size/2 + 5);
            }
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –ö–î
            if (dashCooldown && !isDashing) {
                const elapsed = Date.now() - dashStartTime;
                const progress = Math.min(elapsed / dashCooldownTime, 1);
                
                gameCtx.fillStyle = '#00bfff';
                gameCtx.globalAlpha = 0.3;
                gameCtx.fillRect(cooldownX, cooldownY + size * (1 - progress), size, size * progress);
                gameCtx.globalAlpha = 1.0;
                
                // –í—Ä–µ–º—è –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                const remaining = Math.ceil((dashCooldownTime - elapsed) / 1000);
                gameCtx.fillStyle = '#fff';
                gameCtx.font = 'bold 12px Arial';
                gameCtx.fillText(`${remaining}s`, cooldownX + size/2, cooldownY + size + 15);
            }
            
            gameCtx.restore();
        }
        
        // Allow Enter key to join game
        nicknameInput.addEventListener('keypress', (e) => {
            if (e.code === 'Enter') {
                joinGame();
            }
        });
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.respawnPlayer = respawnPlayer;
        window.showRespawnModal = showRespawnModal;
        window.hideRespawnModal = hideRespawnModal;
        
        // –ü–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ gameContainer, —Ç–æ–∂–µ resize
        gameContainer.style.display = '';

        function openRulesModal() {
          document.getElementById('rulesModal').style.display = 'flex';
        }
        function closeRulesModal(e) {
          // –ó–∞–∫—Ä—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É –∏–ª–∏ –ø–æ ‚úï
          if (!e || e.target.classList.contains('rules-modal-backdrop') || e.target.classList.contains('rules-modal-close')) {
            document.getElementById('rulesModal').style.display = 'none';
          }
        }
    </script>
</body>
</html> 